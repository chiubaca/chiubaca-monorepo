---
import { getCollection } from "astro:content";

import NotePage from "../layouts/NotePage.astro";
import ListingPage from "../layouts/ListingPage.astro";
import FleetingNotesListingPage from "../layouts/FleetingNotesListingPage.astro";

import { noteTypes, type AllPaths } from "../common/types";

type Route = {
  params: { noteRoute: AllPaths };
};

export async function getStaticPaths() {
  const noteTypeTitles = Object.values(noteTypes.enum).map(
    (noteType) => noteType,
  );

  const makeAllRoutes = noteTypeTitles.map(async (noteType) => {
    const notes = await getCollection(noteType);

    const noteTypePaths = notes.map(
      (note) => `${noteType}/${note.slug}` as const,
    );

    return noteTypePaths;
  });

  const allRoutes = await Promise.all(makeAllRoutes);

  const slugPaths: Route[] = allRoutes
    .flat()
    .map((path) => ({ params: { noteRoute: path } }));

  const indexPaths: Route[] = noteTypeTitles.map((noteType) => ({
    params: { noteRoute: noteType },
  }));

  return [...indexPaths, ...slugPaths];
}

const { noteRoute } = Astro.params;

const isListingPage =
  noteRoute === "fleeting-notes" ||
  noteRoute === "literature-notes" ||
  noteRoute === "permanent-notes" ||
  noteRoute === "index-notes";

const isFleetingNotesCollection = noteRoute === "fleeting-notes";
---

{
  isListingPage ? (
    isFleetingNotesCollection ? (
      <FleetingNotesListingPage path={noteRoute} />
    ) : (
      <ListingPage path={noteRoute} />
    )
  ) : (
    <NotePage path={noteRoute} />
  )
}
